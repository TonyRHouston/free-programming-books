name: RTL/LTR Markdown Linter
on:
  workflow_dispatch: {}
permissions:
  contents: read
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    - name: Fetch all history for main
      run: git fetch --no-tags --prune --depth=50 origin main
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
    - name: Install Python dependencies
      run: 'pip install python-bidi PyYAML

        '
    - name: List files in scripts directory and current path
      run: 'echo "Current working directory:"

        pwd

        echo "Listing contents of scripts directory (if it exists at root):"

        ls -la scripts/ || echo "scripts/ directory not found at root or ls failed"

        '
    - name: Get changed Markdown files
      id: changed_md_files
      uses: tj-actions/changed-files@v46
      with:
        files: '**/*.md

          '
    - name: Check for RTL label
      id: rtl_label
      run: 'gh pr view ${{ github.event.pull_request.number }} --json labels --jq
        ''.labels[].name'' | grep -q ''^RTL$'' && echo "has_labels=true" >> $GITHUB_OUTPUT
        || echo "has_labels=false" >> $GITHUB_OUTPUT

        '
      env:
        GH_TOKEN: ${{ github.token }}
    - name: Check for RTL language file changes
      id: rtl_lang_files
      run: "RTL_CHANGED=false\nfor f in ${{ steps.changed_md_files.outputs.all_changed_files\
        \ }}; do\n  if [[ \"$f\" =~ (ar|he|fa|ur) ]]; then\n    RTL_CHANGED=true\n\
        \    break\n  fi\ndone\necho \"rtl_changed=$RTL_CHANGED\" >> $GITHUB_OUTPUT\n"
    - name: Run RTL/LTR Markdown linter
      id: run_linter
      if: steps.rtl_label.outputs.has_labels == 'true' || steps.rtl_lang_files.outputs.rtl_changed
        == 'true'
      continue-on-error: true
      run: "echo \"Scanning all specified paths for full log...\"\necho \"Changed\
        \ Markdown files for PR annotations: ${{ steps.changed_md_files.outputs.all_changed_files\
        \ }}\"\n\nCHANGED_FILES_ARGS=\"\"\nif [ \"${{ steps.changed_md_files.outputs.all_changed_files_count\
        \ }}\" -gt 0 ]; then\n  # Pass changed files to the script for PR annotation\
        \ generation\n  CHANGED_FILES_ARGS=\"--changed-files ${{ steps.changed_md_files.outputs.all_changed_files\
        \ }}\"\nfi\n\n# Execute the linter.\n# Annotations for changed files will\
        \ be printed to stdout by the script.\n# The script will also write a full\
        \ log to 'rtl-linter-output.log'.\n# If the script exits with a non-zero code\
        \ (error found), this step will fail.\npython3 scripts/rtl_ltr_linter.py books\
        \ casts courses more ${CHANGED_FILES_ARGS} --log-file rtl-linter-output.log\n"
    - name: Upload linter output artifact
      if: steps.run_linter.conclusion == 'success' || steps.run_linter.conclusion
        == 'failure'
      uses: actions/upload-artifact@v5
      with:
        name: rtl-linter-output
        path: rtl-linter-output.log
        if-no-files-found: ignore
